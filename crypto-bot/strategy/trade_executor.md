# 트레이딩 봇 시스템 구조 및 로직

## 1. 시스템 아키텍처

```mermaid
graph TD
    A[메인 프로세스] --> B[웹소켓 연결]
    A --> C[포지션 모니터링]
    A --> D[시장 분석]
    A --> E[마켓 메이커]

    B --> F[가격 업데이트]
    B --> G[연결 상태 모니터링]

    C --> H[TP/SL 체크]
    C --> I[트레일링 스탑]
    C --> J[부분 익절]

    D --> K[파동 분석]
    D --> L[모멘텀 전략]
    D --> M[돌파 전략]

    E --> N[그리드 주문]
    E --> O[주문 관리]
```

## 2. 웹소켓 연결 관리

```mermaid
sequenceDiagram
    participant M as 메인 프로세스
    participant W as 웹소켓
    participant B as 바이낸스

    M->>W: 웹소켓 연결 시작
    W->>B: 연결 요청
    B-->>W: 연결 승인
    W->>B: 심볼 구독 요청
    B-->>W: 실시간 가격 데이터

    loop 모니터링
        W->>M: 가격 업데이트
        M->>M: 포지션 체크
    end

    alt 연결 끊김
        W->>M: 에러 발생
        M->>W: 재연결 시도
    end
```

## 3. 포지션 관리 로직

```mermaid
stateDiagram-v2
    [*] --> 포지션 모니터링
    포지션 모니터링 --> TP도달: 가격 >= TP
    포지션 모니터링 --> SL도달: 가격 <= SL
    포지션 모니터링 --> 트레일링스탑: 수익 발생
    포지션 모니터링 --> 부분익절: 부분 TP 도달

    TP도달 --> 포지션종료
    SL도달 --> 포지션종료
    트레일링스탑 --> 포지션종료
    부분익절 --> 포지션모니터링

    포지션종료 --> [*]
```

## 4. 마켓 메이커 전략

```mermaid
graph LR
    A[시장 분석] --> B{그리드 생성}
    B --> C[매수 주문]
    B --> D[매도 주문]

    C --> E[주문 관리]
    D --> E

    E --> F{수익 조건}
    F -->|도달| G[포지션 종료]
    F -->|미도달| E
```

## 5. 주요 기능 설명

### 5.1 웹소켓 관리

- 단일 웹소켓 연결로 모든 심볼 구독
- 3개씩 배치 처리로 구독 요청
- 30초 타임아웃으로 연결 상태 모니터링
- 최대 5회 재연결 시도 후 5분 대기

### 5.2 포지션 모니터링

- 0.5초 간격으로 포지션 상태 체크
- TP/SL 조건 실시간 모니터링
- 트레일링 스탑으로 수익 보호
- 부분 익절 전략으로 수익 실현

### 5.3 마켓 메이커 전략

- 최대 3개 레벨의 그리드 주문
- 0.2% 간격으로 주문 배치
- 30분 주문 유효 시간
- 최대 3개 동시 포지션 제한

### 5.4 리스크 관리

- 일일 최대 손실 제한 (5%)
- 최대 동시 포지션 수 제한
- 변동성 기반 포지션 크기 조절
- 상관관계 기반 포지션 분산

## 6. 에러 처리

```mermaid
graph TD
    A[에러 발생] --> B{에러 유형}
    B -->|웹소켓| C[재연결 시도]
    B -->|API| D[요청 제한 대기]
    B -->|주문| E[주문 재시도]

    C --> F{성공?}
    F -->|Yes| G[정상 진행]
    F -->|No| H[대기 후 재시도]

    D --> I[1분 대기]
    I --> G

    E --> J{성공?}
    J -->|Yes| G
    J -->|No| K[에러 로깅]
```

## 7. 성능 최적화

- 가격 데이터 캐싱으로 API 요청 최소화
- 배치 처리로 웹소켓 구독 부하 감소
- 주기적인 포지션 동기화로 데이터 정확성 유지
- 시스템 리소스 모니터링으로 안정성 확보
